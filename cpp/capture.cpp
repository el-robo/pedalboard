#include <algorithm>
#include <array>
#include <cstdio>
#include <chrono>
#include <fmt/base.h>
#include <fmt/format.h>
#include <initializer_list>
#include <libremidi/defaults.hpp>
#include <libremidi/input_configuration.hpp>
#include <libremidi/libremidi.hpp>
#include <libremidi/observer_configuration.hpp>
#include <thread>

using namespace libremidi;
using namespace std::chrono_literals;

constexpr auto hall_of_fame_2 = 0x21;
constexpr std::array< unsigned char, 5 > preamble =
{
    0x00, 0x20, 0x1F, 0x00, hall_of_fame_2
};

enum class event
{
    probe = 0x03,
    ping = 0x05,
    state = 0x08,
    query = 0x09,
    start_preset = 0x1E,
    preset = 0x0D,
    foot = 0x0F
};

const auto target_name = "WINE midi driver";
const auto client_name = "toneprint-capture";

auto find_target_port( const auto &ports )
{
    for( auto &port : ports )
    {
        if( port.device_name == target_name )
        {
            fmt::println( "port {} - {} - {}", port.port_name, port.device_name, port.display_name );
            return port;
        }

    }

    return ports.at( 0 );
}

auto find_input()
{
    observer observer( { .track_virtual = true } );
    auto ports = observer.get_input_ports();
    return find_target_port( ports );
}

auto find_output()
{
    observer observer( { .track_virtual = true } );
    auto ports = observer.get_output_ports();
    return find_target_port( ports );
}

void send( midi_out &output, const libremidi::message &message )
{
    output.send_message( message );
    std::this_thread::sleep_for( 10ms );
}

void respond_to_probe( midi_out &output )
{
    fmt::println( "responding to probe" );
    send( output, { 0x04, 0x00, 0x42, 0x06, 0x00, 0x00 } );
    send( output, { 0x06, 0x78, 0x7F, 0x7F, 0x7F, 0x7F } );
    send( output, { 0x26, 0x00, 0x00 } );
    send( output, { 0x0E, 0x00, 0x00, 0x01, 0x00, 0x00 } );
    send( output, { 0x0F, 0x00, 0x55, 0x49, 0x3A, 0x0A, 0x00 } );
    send( output, { 0x0F, 0x00, 0x42, 0x79, 0x70, 0x61, 0x73, 0x73, 0x65, 0x00, 0x64, 0x73, 0x65, 0x64, 0x0A, 0x00 } );

    send( output, { 0x0F, 0x00, 0x50, 0x72, 0x65, 0x73, 0x65, 0x74, 0x3A, 0x00, 0x20, 0x35, 0x0A, 0x00 } );
    send( output, { 0x08, 0x11, 0x21, 0x02, 0x62, 0x01, 0x65, 0x01, 0x55, 0x00, 0x01, 0x58, 0x02, 0x67, 0x02, 0x00, 0x00, 0x04, 0x26, 0x03, 0x27, 0x03, 0x6C, 0x02, 0x18, 0x00, 0x01, 0x03, 0x00, 0x00 } );
    send( output, { 0x08, 0x11, 0x21, 0x02, 0x62, 0x01, 0x65, 0x01, 0x55, 0x00, 0x01, 0x58, 0x02, 0x68, 0x02, 0x00, 0x00, 0x04, 0x26, 0x03, 0x27, 0x03, 0x6C, 0x02, 0x18, 0x00, 0x01, 0x03, 0x00, 0x00 } );
    send( output, { 0x14, 0x78, 0x7F, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x06, 0x00, 0x42, 0x00, 0x00, 0x36, 0x16, 0x00, 0x00, 0x06, 0x10, 0x40, 0x00, 0x1D, 0x7B, 0x74, 0x00, 0x00, 0x00, 0x00, 0x40 } );
    send( output, { 0x1D, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x06, 0x79, 0x00,  0x00, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x09 } );
    fmt::println( "done" );
}

void respond_to_state_request( midi_out &output )
{
    fmt::println( "responding to state request" );
    send( output, { 0x06, 0x78, 0x7f, 0x7f, 0x7f, 0x7f } );
    send( output, { 0x26, 0x00, 0x00 } );
    send( output, { 0x08, 0x11, 0x4B, 0x03, 0x32, 0x01, 0x50, 0x01, 0x55, 0x00, 0x01, 0x59, 0x02, 0x67, 0x02, 0x00, 0x00, 0x04, 0x26, 0x03, 0x27, 0x03, 0x6C, 0x02, 0x18, 0x00, 0x01, 0x03, 0x00, 0x00 } );
    send( output, { 0x08, 0x11, 0x4B, 0x03, 0x32, 0x01, 0x50, 0x01, 0x55, 0x00, 0x01, 0x59, 0x02, 0x67, 0x02, 0x00, 0x00, 0x04, 0x26, 0x03, 0x27, 0x03, 0x6C, 0x02, 0x18, 0x00, 0x01, 0x03, 0x00, 0x00 } );
    send( output, { 0x14, 0x78, 0x7F, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x06, 0x00, 0x42, 0x00, 0x00, 0x36, 0x16, 0x00, 0x00, 0x06, 0x10, 0x40, 0x00, 0x1D, 0x7B, 0x74, 0x00, 0x00, 0x00, 0x00, 0x40 } );
    send( output, { 0x1D, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0C, 0x67, 0x00, 0x00, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x10, 0x77 } );;
}

void respond_to_query( midi_out &output )
{
    fmt::println( "responding to query" );
    send( output, { 0x26, 0x00, 0x00 } );
    send( output, { 0x08, 0x11, 0x4B, 0x03, 0x32, 0x01, 0x50, 0x01, 0x55, 0x00, 0x01, 0x59, 0x02, 0x67, 0x02, 0x00, 0x00, 0x04, 0x26, 0x03, 0x27, 0x03, 0x6C, 0x02, 0x18, 0x00, 0x01, 0x03, 0x00, 0x00 } );
    send( output, { 0x14, 0x78, 0x7F, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x06, 0x00, 0x42, 0x00, 0x00, 0x36, 0x16, 0x00, 0x00, 0x06, 0x10, 0x40, 0x00, 0x1D, 0x7B, 0x74, 0x00, 0x00, 0x00, 0x00, 0x40 } );
    send( output, { 0x1D, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0C, 0x67, 0x00, 0x00, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x10, 0x77 } );
    send( output, { 0x26, 0x00, 0x00 } );
    send( output, { 0x08, 0x11, 0x4B, 0x03, 0x32, 0x01, 0x50, 0x01, 0x55, 0x00, 0x01, 0x59, 0x02, 0x67, 0x02, 0x00, 0x00, 0x04, 0x26, 0x03, 0x27, 0x03, 0x6C, 0x02, 0x18, 0x00, 0x01, 0x03, 0x00, 0x00 } );
}

void handle( unsigned char type, const std::span< unsigned char > &body, midi_out &output )
{
    switch( static_cast< event >( type ) )
    {
        case event::probe:
            respond_to_probe( output );
            break;

        case event::ping:
            respond_to_state_request( output );
            break;

        case event::query:
            respond_to_query( output );
            break;

        case event::start_preset:
            break;

        case event::preset:
            break;

        default:
            break;
    }
}

int main( int argc, char **argv )
{
    midi_out output( {} );
    output.open_port( find_output() );

    midi_in input(
    {
        .on_message = [ & ]( message &&message )
        {
            if( message.size() < preamble.size() + 2 || !std::equal( preamble.begin(), preamble.end(),  message.begin() + 1 ) )
            {
                return;
            }

            const auto type = message[ 6 ];
            const auto body = std::span( message.begin() + 7, message.end() );

            fmt::println( "got message of type {:X}", type );
            handle( type, body, output );
        },
        .ignore_sysex = false,
        .ignore_timing = true,
        .ignore_sensing = true,
    } );

    input.open_port( find_input() );

    fmt::print( "starting\n" );

    int c;
    while ((c = getchar()) != '\n' && c != EOF)
    {

    }

    fmt::print( "done\n" );
    return 0;
}
